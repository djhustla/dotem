<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; position:relative;
        }

        /* Boutons fixes en haut */
        .buttons-container {
          position: fixed; top:20px; right:20px;
          display:flex; gap:10px; z-index:100;
        }
        .buttons-container button {
          background:#fff; color:#667eea; border:none; padding:8px 16px; border-radius:10px;
          font-size:0.95rem; font-weight:600; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.2); transition:all 0.2s;
        }
        .buttons-container button:hover { background:#667eea; color:#fff; }

        .profile-container {
          background:white; border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,0.3);
          overflow:hidden; width:100%; max-width:500px;
        }
        .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          padding:40px 30px; text-align:center; color:white;
        }
        .profile-photo { width:120px; height:120px; border-radius:50%; border:4px solid white; margin-bottom:15px; object-fit:cover; }
        h1 { font-size:2rem; font-weight:700; margin-bottom:5px; }
        .profile-content { padding:30px; }
        .info-group { margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #e5e7eb; }
        .info-group:last-child { border-bottom:none; }
        .info-label { font-size:0.85rem; color:#9ca3af; font-weight:600; margin-bottom:5px; }
        .info-value { font-size:1.1rem; color:#374151; font-weight:500; }
        .loading { text-align:center; padding:40px; color:#667eea; }
    </style>
</head>
<body>

<div class="buttons-container">
    <button onclick="window.location.href='menu.html'">â¬… Retour au menu</button>
    <button id="btnLogout">ðŸšª DÃ©connexion</button>
</div>

<div class="profile-container">
    <div class="header">
        <img id="profilePhoto" class="profile-photo" src="" alt="Photo de profil">
        <h1 id="profileUsername">Chargement...</h1>
    </div>

    <div class="profile-content" id="profileContent">
        <div class="loading">Chargement des informations...</div>
    </div>
</div>

<script>
    const token = localStorage.getItem('accessToken');

    // VÃ©rifier si l'utilisateur est connectÃ©
    if (!token) {
        alert('Vous devez Ãªtre connectÃ© pour voir votre profil');
        window.location.href = '/connection/connection.html';
    }

    async function loadProfile() {
        try {
            const response = await fetch('/api/users/me', {
                method:'GET',
                headers:{ 'Authorization':'Bearer '+token }
            });
            if(!response.ok) throw new Error('Session expirÃ©e');

            const user = await response.json();

            document.getElementById('profileUsername').textContent = user.username;
            document.getElementById('profilePhoto').src = user.photoUrl || 'https://ui-avatars.com/api/?name='+user.username;

            document.getElementById('profileContent').innerHTML = `
                <div class="info-group">
                    <div class="info-label">Nom d'utilisateur</div>
                    <div class="info-value">${user.username}</div>
                </div>
                <div class="info-group">
                    <div class="info-label">Email</div>
                    <div class="info-value">${user.email}</div>
                </div>
                <div class="info-group">
                    <div class="info-label">RÃ´le</div>
                    <div class="info-value">${user.role}</div>
                </div>
                <div class="info-group">
                    <div class="info-label">Membre depuis</div>
                    <div class="info-value">${new Date(user.createdAt).toLocaleDateString('fr-FR')}</div>
                </div>
            `;

            // DÃ©connexion
            document.getElementById('btnLogout').addEventListener('click', async () => {
                const refreshToken = localStorage.getItem('refreshToken');
                if(!refreshToken) return;

                try {
                    const res = await fetch('/api/auth/logout', {
                        method:'POST',
                        headers:{ 'Content-Type':'application/json' },
                        body: JSON.stringify({ refreshToken })
                    });
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    alert('DÃ©connexion rÃ©ussie');
                    window.location.href = '/connection/connection.html';
                } catch(err){
                    alert('Erreur rÃ©seau lors de la dÃ©connexion');
                }
            });

        } catch(error) {
            alert('Erreur : '+error.message);
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = '/connection/connection.html';
        }
    }

    loadProfile();
</script>

</body>
</html>
