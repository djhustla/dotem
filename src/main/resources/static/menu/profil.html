<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Utilisateur</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; position:relative;
        }

        /* Boutons fixes en haut */
        .buttons-container {
          position: fixed; top:20px; right:20px;
          display:flex; gap:10px; z-index:100;
        }
        .buttons-container button {
          background:#fff; color:#667eea; border:none; padding:8px 16px; border-radius:10px;
          font-size:0.95rem; font-weight:600; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.2); transition:all 0.2s;
        }
        .buttons-container button:hover { background:#667eea; color:#fff; }

        .profile-container {
          background:white; border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,0.3);
          overflow:hidden; width:100%; max-width:500px;
        }
        .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          padding:40px 30px; text-align:center; color:white;
          position: relative;
        }
        .profile-photo { width:120px; height:120px; border-radius:50%; border:4px solid white; margin-bottom:15px; object-fit:cover; }
        h1 { font-size:2rem; font-weight:700; margin-bottom:5px; }
        .profile-content { padding:30px; }
        .info-group { margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #e5e7eb; }
        .info-group:last-child { border-bottom:none; }
        .info-label { font-size:0.85rem; color:#9ca3af; font-weight:600; margin-bottom:5px; }
        .info-value { font-size:1.1rem; color:#374151; font-weight:500; }
        .loading { text-align:center; padding:40px; color:#667eea; }
        .error { text-align:center; padding:40px; color:#dc2626; }

        /* Bouton discuter */
        .chat-button {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 25px;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 8px;
          margin: 20px auto;
          width: fit-content;
        }
        .chat-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }
        .chat-button:active {
          transform: translateY(0);
        }

        /* Styles pour les pr√©f√©rences musicales */
        .preferences-section {
          background:#f8f9ff;
          border:2px solid #e0e7ff;
          border-radius:12px;
          padding:20px;
          margin:20px 0;
        }
        .preferences-title {
          font-weight:700;
          color:#667eea;
          margin-bottom:15px;
          text-align:center;
          font-size:1.1rem;
        }
        .preference-item {
          display:flex;
          justify-content:space-between;
          align-items:center;
          padding:10px 0;
          border-bottom:1px solid #e5e7eb;
        }
        .preference-item:last-child {
          border-bottom:none;
        }
        .preference-genre {
          font-weight:600;
          color:#374151;
        }
        .preference-level {
          font-size:0.85rem;
          padding:6px 12px;
          border-radius:8px;
          font-weight:500;
        }
        .level-3 { background:#dbeafe; color:#2563eb; } /* Adore */
        .level-2 { background:#d1fae5; color:#059669; } /* Appr√©cie */
        .level-1 { background:#fef3c7; color:#d97706; } /* Neutre */
        .level-0 { background:#fee2e2; color:#dc2626; } /* D√©teste */
        .no-preferences {
          color:#6b7280;
          font-style:italic;
          text-align:center;
          padding:15px;
        }

        /* Styles pour le son d'entr√©e (cach√©) */
        .audio-player {
          display: none;
        }

        /* Indicateur de son en cours */
        .son-playing-indicator {
          position: fixed;
          top: 20px;
          left: 20px;
          background: rgba(16, 185, 129, 0.9);
          color: white;
          padding: 8px 16px;
          border-radius: 20px;
          font-size: 0.9rem;
          font-weight: 600;
          z-index: 1000;
          display: none;
          align-items: center;
          gap: 8px;
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<!-- Indicateur de son en cours -->
<div id="sonPlayingIndicator" class="son-playing-indicator">
    üîà Son d'entr√©e en cours...
</div>

<div class="buttons-container">
    <button onclick="window.location.href='/menu/afficherUserList.html'">‚¨Ö Retour √† la liste</button>
    <button id="btnLogout">üö™ D√©connexion</button>
</div>

<div class="profile-container">
    <div class="header">
        <img id="profilePhoto" class="profile-photo" src="" alt="Photo de profil">
        <h1 id="profileUsername">Chargement...</h1>
    </div>

    <div class="profile-content" id="profileContent">
        <div class="loading">Chargement des informations...</div>
    </div>
</div>

<!-- Lecteur audio cach√© -->
<audio id="sonEntreePlayer" class="audio-player"></audio>

<script>
    const token = localStorage.getItem('accessToken');

    // V√©rifier si l'utilisateur est connect√©
    if (!token) {
        alert('Vous devez √™tre connect√© pour voir les profils');
        window.location.href = '/connection/connection.html';
    }

    // Variables pour stocker les donn√©es
    let currentUserId = null;
    let targetUserId = null;

    // R√©cup√©rer l'ID depuis les param√®tres d'URL
    function getUserIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('userId');
    }

    // R√©cup√©rer l'ID de l'utilisateur courant
    async function getCurrentUserId() {
        try {
            const response = await fetch('/api/users/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!response.ok) throw new Error('Erreur lors de la r√©cup√©ration du profil');
            const userData = await response.json();
            return userData.id;
        } catch (error) {
            console.error('Erreur:', error);
            return null;
        }
    }

    // Fonction pour charger les pr√©f√©rences musicales
    async function loadMusicPreferences(userId) {
        try {
            const response = await fetch(`/api/users/${userId}/music-preferences`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (response.ok) {
                const preferences = await response.json();
                return preferences;
            } else {
                return [];
            }
        } catch (err) {
            console.error('Erreur chargement pr√©f√©rences:', err);
            return [];
        }
    }

    // Fonction pour nettoyer l'URL des sauts de ligne
    function cleanUrl(url) {
        if (!url) return '';
        return url.replace(/\n/g, '').replace(/\r/g, '').trim();
    }

    // Fonction pour jouer le son d'entr√©e
    function playSonEntree(sonUrl) {
        if (!sonUrl) return;

        const cleanedUrl = cleanUrl(sonUrl);
        const audioPlayer = document.getElementById('sonEntreePlayer');
        const indicator = document.getElementById('sonPlayingIndicator');

        // Configurer le lecteur audio
        audioPlayer.src = cleanedUrl;
        audioPlayer.volume = 0.7; // Volume √† 70%

        // Afficher l'indicateur
        indicator.style.display = 'flex';

        // √âv√©nement quand la lecture commence
        audioPlayer.onplay = function() {
            console.log('üéµ Son d\'entr√©e en cours de lecture');
        };

        // √âv√©nement quand la lecture se termine
        audioPlayer.onended = function() {
            indicator.style.display = 'none';
            console.log('üéµ Son d\'entr√©e termin√©');
        };

        // √âv√©nement en cas d'erreur
        audioPlayer.onerror = function() {
            indicator.style.display = 'none';
            console.error('‚ùå Erreur lors de la lecture du son');
        };

        // D√©marrer la lecture
        audioPlayer.play().catch(error => {
            console.error('Erreur de lecture audio:', error);
            indicator.style.display = 'none';
        });
    }

    // Fonction pour afficher les pr√©f√©rences musicales
    function displayMusicPreferences(preferences) {
        if (!preferences || preferences.length === 0) {
            return `
                <div class="preferences-section">
                    <div class="preferences-title">üéµ Pr√©f√©rences Musicales</div>
                    <div class="no-preferences">Aucune pr√©f√©rence musicale d√©finie</div>
                </div>
            `;
        }

        let html = `
            <div class="preferences-section">
                <div class="preferences-title">üéµ Pr√©f√©rences Musicales</div>
        `;

        preferences.forEach(pref => {
            const levelClass = `level-${pref.level}`;
            const levelText = getLevelText(pref.level);
            const genreName = formatGenreName(pref.musicType);

            html += `
                <div class="preference-item">
                    <span class="preference-genre">${genreName}</span>
                    <span class="preference-level ${levelClass}">${levelText}</span>
                </div>
            `;
        });

        html += `</div>`;
        return html;
    }

    // Fonction pour formater le nom du genre
    function formatGenreName(genre) {
        const genreNames = {
            'KPOP': 'K-Pop',
            'RAP_FRANCAIS': 'Rap Fran√ßais',
            'RAP_AMERICAIN': 'Rap Am√©ricain',
            'LATINO': 'Latino',
            'COMMERCIAL': 'Commercial',
            'ELECTRO': 'Electro'
        };
        return genreNames[genre] || genre;
    }

    // Fonction pour obtenir le texte du niveau
    function getLevelText(level) {
        const levels = {
            3: '‚ù§Ô∏è Adore',
            2: 'üòä Appr√©cie',
            1: 'üòê Neutre',
            0: 'üò† D√©teste'
        };
        return levels[level] || 'Inconnu';
    }

    async function loadUserProfile() {
        targetUserId = getUserIdFromURL();

        if (!targetUserId) {
            document.getElementById('profileContent').innerHTML = `
                <div class="error">ID utilisateur manquant dans l'URL</div>
            `;
            return;
        }

        try {
            // R√©cup√©rer l'ID de l'utilisateur courant
            currentUserId = await getCurrentUserId();
            if (!currentUserId) {
                throw new Error('Impossible de r√©cup√©rer votre profil');
            }

            // Charger les donn√©es du profil cible
            const response = await fetch(`/api/users/${targetUserId}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Utilisateur non trouv√©');
                }
                throw new Error('Erreur lors du chargement du profil');
            }

            const user = await response.json();

            // Mettre √† jour l'interface
            document.getElementById('profileUsername').textContent = user.username;
            document.getElementById('profilePhoto').src = user.photoUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&size=120&background=667eea&color=fff`;

            // Gestion de l'erreur de chargement de l'image
            document.getElementById('profilePhoto').onerror = function() {
                this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&size=120&background=667eea&color=fff`;
            };

            // JOUER LE SON D'ENTR√âE IMM√âDIATEMENT
            if (user.sonEntreeURL) {
                playSonEntree(user.sonEntreeURL);
            }

            // V√©rifier si c'est le profil de l'utilisateur courant
            const isCurrentUser = (currentUserId.toString() === targetUserId.toString());

            let preferencesSection = '';

            // Si c'est l'utilisateur courant, charger et afficher les pr√©f√©rences musicales
            if (isCurrentUser) {
                const preferences = await loadMusicPreferences(targetUserId);
                preferencesSection = displayMusicPreferences(preferences);
            }

            // Afficher les informations du profil
            document.getElementById('profileContent').innerHTML = `
                <div class="info-group">
                    <div class="info-label">Nom d'utilisateur</div>
                    <div class="info-value">${user.username}</div>
                </div>
                <div class="info-group">
                    <div class="info-label">Email</div>
                    <div class="info-value">${user.email}</div>
                </div>
                <div class="info-group">
                    <div class="info-label">R√¥le</div>
                    <div class="info-value">${user.role}</div>
                </div>
                <div class="info-group">
                    <div class="info-label">Membre depuis</div>
                    <div class="info-value">${new Date(user.createdAt).toLocaleDateString('fr-FR')}</div>
                </div>

                ${preferencesSection}

                <!-- Bouton Discuter - affich√© seulement si ce n'est PAS l'utilisateur courant -->
                ${!isCurrentUser ? `
                    <button class="chat-button" onclick="startConversation('${user.id}', '${user.username}')">
                        üí¨ Discuter avec ${user.username}
                    </button>
                ` : ''}
            `;

        } catch(error) {
            console.error('Erreur:', error);
            document.getElementById('profileContent').innerHTML = `
                <div class="error">
                    ${error.message}
                    <br><br>
                    <button onclick="loadUserProfile()" style="margin-top:10px; padding:8px 16px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer;">
                        R√©essayer
                    </button>
                </div>
            `;
        }
    }

    // Fonction pour d√©marrer une conversation
    function startConversation(userId, username) {
        // Rediriger vers la page de conversation avec l'ID de l'utilisateur
        window.location.href = `/menu/ma_communaute/conversation.html?userId=${userId}`;
    }

    // D√©connexion
    document.getElementById('btnLogout').addEventListener('click', async () => {
        const refreshToken = localStorage.getItem('refreshToken');

        try {
            if (refreshToken) {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify({ refreshToken })
                });
            }

            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            alert('D√©connexion r√©ussie');
            window.location.href = '/connection/connection.html';

        } catch(err) {
            console.error('Erreur d√©connexion:', err);
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = '/connection/connection.html';
        }
    });

    // Charger le profil au d√©marrage
    document.addEventListener('DOMContentLoaded', loadUserProfile);
</script>

</body>
</html>