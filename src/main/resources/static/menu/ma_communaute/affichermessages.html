<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des Messages</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 40px 20px; position: relative;
    }
    body::before {
      content: ''; position: fixed; top:0; left:0; width:100%; height:100%;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      pointer-events:none; z-index:0;
    }
    .header { text-align:center; margin-bottom:40px; position:relative; z-index:1; }
    h1 { color:white; font-size:2.5rem; font-weight:700; text-shadow:0 2px 20px rgba(0,0,0,0.2); margin-bottom:8px; letter-spacing:-0.5px; }
    .subtitle { color: rgba(255,255,255,0.9); font-size:1rem; font-weight:400; }

    .container { max-width:800px; margin:0 auto; background:white; padding:0; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; position:relative; z-index:1; }
    .messages-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:20px 30px; color:white; font-size:1.2rem; font-weight:600; border-bottom:3px solid rgba(255,255,255,0.2); }
    #messages { padding:20px; max-height:600px; overflow-y:auto; }
    #messages::-webkit-scrollbar { width:8px; }
    #messages::-webkit-scrollbar-track { background:#f1f1f1; border-radius:10px; }
    #messages::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:10px; }

    .message { padding:15px; margin-bottom:20px; background:#fff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); border:1px solid #e5e7eb; }
    .message-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .message-header img { width:45px; height:45px; border-radius:50%; object-fit:cover; border:2px solid #667eea; }
    .user-info { flex:1; }
    .username { font-weight:600; color:#667eea; font-size:1.1rem; }
    .time { font-size:0.8rem; color:#9ca3af; margin-top:2px; }
    .message-text { color:#333; font-size:1rem; line-height:1.5; margin-bottom:15px; padding-left:57px; }

    /* NOUVEAU : Section commentaires */
    .comments-section { margin-top:15px; padding-top:15px; border-top:1px solid #e5e7eb; }
    .comments-header { display:flex; align-items:center; gap:8px; margin-bottom:12px; color:#667eea; font-weight:600; font-size:0.9rem; }
    .comment-count { background:#667eea; color:white; padding:2px 8px; border-radius:12px; font-size:0.8rem; }

    .comment-form { display:flex; gap:10px; margin-bottom:15px; }
    .comment-input { flex:1; padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:0.9rem; resize:none; min-height:40px; }
    .comment-input:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 2px rgba(102, 126, 234, 0.2); }
    .comment-submit { background:#667eea; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; transition:background 0.2s; }
    .comment-submit:hover { background:#5a6fd8; }
    .comment-submit:disabled { background:#9ca3af; cursor:not-allowed; }

    .comments-list { max-height:200px; overflow-y:auto; }
    .comment { display:flex; gap:10px; padding:10px; margin-bottom:8px; background:#f8fafc; border-radius:8px; border-left:3px solid #667eea; }
    .comment-avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; }
    .comment-content { flex:1; }
    .comment-author { font-weight:600; color:#667eea; font-size:0.85rem; }
    .comment-text { color:#4b5563; font-size:0.9rem; margin-top:2px; line-height:1.4; }
    .comment-time { color:#9ca3af; font-size:0.75rem; margin-top:4px; }

    .loading { text-align:center; padding:40px; color:#667eea; font-size:1.1rem; }
    .error { text-align:center; padding:40px; color:#ef4444; font-size:1.1rem; background:#fee; border-radius:12px; margin:20px; }
    .empty-state { text-align:center; padding:60px 20px; color:#9ca3af; }
    .empty-state::before { content:'ðŸ“­'; display:block; font-size:4rem; margin-bottom:16px; }

    /* Boutons */
    .buttons-container { position:absolute; top:20px; right:20px; display:flex; gap:10px; z-index:10; }
    .back-button, .logout-button {
      background:#fff; color:#667eea; border:none; padding:10px 18px; border-radius:10px;
      font-size:0.95rem; font-weight:600; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.2);
      transition:all 0.2s ease-in-out;
    }
    .back-button:hover, .logout-button:hover { background:#667eea; color:#fff; }

    @media(max-width:768px){
      .buttons-container { top:10px; right:10px; flex-direction:column; }
      .back-button, .logout-button { padding:8px 14px; font-size:0.85rem; }
      .message-text { padding-left:0; }
      .comment-form { flex-direction:column; }
    }
  </style>
</head>
<body>

<div class="buttons-container">
  <button class="back-button" onclick="window.location.href='/menu/menu.html'">â¬… Retour au menu</button>
  <button class="logout-button" id="btnLogout">ðŸšª DÃ©connexion</button>
</div>

<div class="header">
  <h1>Messages</h1>
  <div class="subtitle">Fil de discussion en temps rÃ©el</div>
</div>

<div class="container">
  <div class="messages-header">Derniers messages</div>
  <div id="messages">
    <div class="loading">Chargement des messages...</div>
  </div>
</div>

<script>
  const token = localStorage.getItem('accessToken');

  // VÃ©rification d'authentification
  if (!token) {
    alert('Vous devez Ãªtre connectÃ© pour voir les messages');
    window.location.href = '/connection/connection.html';
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString('fr-FR', {
      day:'2-digit',
      month:'2-digit',
      year:'numeric',
      hour:'2-digit',
      minute:'2-digit'
    });
  }

  function formatCommentDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);

    if (diffMins < 1) return 'Ã€ l\'instant';
    if (diffMins < 60) return `Il y a ${diffMins} min`;
    if (diffHours < 24) return `Il y a ${diffHours} h`;

    return date.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit' });
  }

  async function fetchMessages() {
    try {
      const response = await fetch('/api/messages', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!response.ok) throw new Error('Erreur API');
      const messages = await response.json();
      const container = document.getElementById('messages');
      container.innerHTML = '';

      if (messages.length === 0) {
        container.innerHTML = '<div class="empty-state">Aucun message pour le moment</div>';
        return;
      }

      // Charger les commentaires pour chaque message
      for (const msg of messages) {
        await afficherMessageAvecCommentaires(msg, container);
      }

    } catch(err) {
      console.error(err);
      document.getElementById('messages').innerHTML = '<div class="error">Impossible de charger les messages. Veuillez rÃ©essayer.</div>';
    }
  }

  async function afficherMessageAvecCommentaires(msg, container) {
    try {
      // RÃ©cupÃ©rer les commentaires pour ce message
      const commentsResponse = await fetch(`/api/commentaires/message/${msg.id}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      let comments = [];
      if (commentsResponse.ok) {
        const commentsData = await commentsResponse.json();
        comments = commentsData.commentaires || [];
      }

      const div = document.createElement('div');
      div.className = 'message';
      const photoUrl = msg.photoUrl || "/photos/default.png";

      div.innerHTML = `
        <div class="message-header">
          <img src="${photoUrl}" alt="photo de ${msg.username}">
          <div class="user-info">
            <div class="username">${msg.username}</div>
            <div class="time">${formatDate(msg.heureMessage)}</div>
          </div>
        </div>
        <div class="message-text">${msg.intituleMessage}</div>

        <div class="comments-section">
          <div class="comments-header">
            <span>ðŸ’¬ Commentaires</span>
            <span class="comment-count">${comments.length}</span>
          </div>

          <div class="comment-form">
            <textarea
              class="comment-input"
              placeholder="Ajouter un commentaire..."
              data-message-id="${msg.id}"
            ></textarea>
            <button class="comment-submit" data-message-id="${msg.id}">Commenter</button>
          </div>

          <div class="comments-list" id="comments-${msg.id}">
            ${comments.map(comment => `
              <div class="comment">
                <img src="${comment.userPhotoUrl || '/photos/default.png'}" alt="photo de ${comment.username}" class="comment-avatar">
                <div class="comment-content">
                  <div class="comment-author">${comment.username}</div>
                  <div class="comment-text">${comment.texte}</div>
                  <div class="comment-time">${formatCommentDate(comment.createdAt)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      container.appendChild(div);

      // Ajouter l'Ã©vÃ©nement pour le bouton de commentaire
      const submitBtn = div.querySelector('.comment-submit');
      const textarea = div.querySelector('.comment-input');

      submitBtn.addEventListener('click', () => ajouterCommentaire(msg.id, textarea, submitBtn));
      textarea.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          ajouterCommentaire(msg.id, textarea, submitBtn);
        }
      });

    } catch (error) {
      console.error('Erreur lors du chargement des commentaires:', error);
    }
  }

  async function ajouterCommentaire(messageId, textarea, submitBtn) {
    const texte = textarea.value.trim();
    if (!texte) {
      alert('Veuillez Ã©crire un commentaire');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Envoi...';

    try {
      const response = await fetch(`/api/commentaires/message/${messageId}`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ texte })
      });

      if (response.ok) {
        const result = await response.json();
        textarea.value = '';

        // Recharger les messages pour afficher le nouveau commentaire
        await fetchMessages();
      } else {
        const error = await response.json();
        alert('Erreur: ' + (error.error || 'Impossible d\'ajouter le commentaire'));
      }
    } catch (error) {
      console.error('Erreur:', error);
      alert('Erreur rÃ©seau lors de l\'ajout du commentaire');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Commenter';
    }
  }

  window.addEventListener('DOMContentLoaded', fetchMessages);

  // DÃ©connexion
  document.getElementById('btnLogout').addEventListener('click', async () => {
    const refreshToken = localStorage.getItem('refreshToken');
    if (!refreshToken) return;

    try {
      const res = await fetch('/api/auth/logout', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ refreshToken })
      });
      if(res.ok) {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        alert('DÃ©connexion rÃ©ussie');
        window.location.href = '/connection/connection.html';
      } else {
        alert('Erreur lors de la dÃ©connexion');
      }
    } catch(err) {
      alert('Erreur rÃ©seau lors de la dÃ©connexion');
    }
  });
</script>

</body>
</html>