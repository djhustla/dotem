<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CrÃ©er un message</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh; display:flex; justify-content:center; align-items:flex-start; padding:80px 20px 20px 20px; position:relative;
    }

    .buttons-container {
      position: fixed;
      top: 20px; right:20px;
      display:flex; gap:10px; z-index:100;
    }
    .buttons-container button {
      background:#fff; color:#667eea; border:none; padding:8px 16px; border-radius:10px;
      font-size:0.95rem; font-weight:600; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.2); transition:all 0.2s;
    }
    .buttons-container button:hover { background:#667eea; color:#fff; }

    .container { background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; width:100%; max-width:600px; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:30px; color:white; text-align:center; }
    .header h1 { font-size:2rem; margin-bottom:8px; font-weight:600; }
    .header p { font-size:0.95rem; opacity:0.9; }
    .user-info { background: rgba(255,255,255,0.1); padding:12px 20px; margin-top:15px; border-radius:10px; font-size:0.9rem; display:inline-block; }

    form { padding:40px 30px; }
    label { display:block; font-weight:600; color:#374151; margin-bottom:10px; font-size:1rem; }
    textarea {
      width:100%; padding:15px; border:2px solid #e5e7eb; border-radius:12px; font-size:1rem; font-family:inherit; resize:vertical; min-height:150px; transition:all 0.3s;
    }
    textarea:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 4px rgba(102,126,234,0.1); }
    .char-count { text-align:right; color:#9ca3af; font-size:0.85rem; margin-top:8px; }

    button[type="submit"] {
      width:100%; padding:15px; margin-top:20px; border:none; border-radius:12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-size:1.1rem; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(102,126,234,0.3); transition:all 0.3s;
    }
    button[type="submit"]:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(102,126,234,0.4); }
    button[type="submit"]:active { transform:translateY(0); }
    button:disabled { opacity:0.6; cursor:not-allowed; transform:none; }

    .error, .success { padding:15px; border-radius:10px; margin-bottom:20px; display:none; }
    .error { background:#fee; color:#dc2626; border:1px solid #fecaca; }
    .success { background:#d1fae5; color:#065f46; border:1px solid #a7f3d0; }

    @media(max-width:480px){
      body{padding:100px 15px 15px 15px;}
      .header h1{font-size:1.4rem;}
      form{padding:25px 15px;}
      button[type="submit"]{font-size:1rem;}
    }
  </style>
</head>
<body>

<div class="buttons-container">
  <button onclick="window.location.href='/menu/menu.html'">â¬… Retour au menu</button>
  <button id="btnLogout">ðŸšª DÃ©connexion</button>
</div>

<div class="container">
  <div class="header">
    <h1>Nouveau message</h1>
    <p>Partagez vos pensÃ©es avec la communautÃ©</p>
    <div class="user-info" id="userInfo">Chargement...</div>
  </div>

  <form id="messageForm">
    <div class="error" id="errorMsg"></div>
    <div class="success" id="successMsg"></div>

    <label for="messageText">Votre message</label>
    <textarea id="messageText" name="message" placeholder="Ã‰crivez votre message ici..." required maxlength="500"></textarea>
    <div class="char-count"><span id="charCount">0</span> / 500 caractÃ¨res</div>
    <button type="submit" id="submitBtn">Publier le message</button>
  </form>
</div>

<script>
  const token = localStorage.getItem('accessToken');
  let currentUser = null;

  // VÃ©rification d'authentification
  if (!token) {
    alert('Vous devez Ãªtre connectÃ© pour poster un message');
    window.location.href = '/connection/connection.html';
  }

  // ========================
  // DÃ©connexion
  // ========================
  document.getElementById('btnLogout').addEventListener('click', async () => {
    const refreshToken = localStorage.getItem('refreshToken');
    if (!refreshToken) return;
    try {
      const res = await fetch('/api/auth/logout', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ refreshToken })
      });
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      alert('DÃ©connexion rÃ©ussie');
      window.location.href = '/connection/connection.html';
    } catch(err) {
      alert('Erreur rÃ©seau lors de la dÃ©connexion');
    }
  });

  // ========================
  // RÃ©cupÃ©rer l'utilisateur connectÃ©
  // ========================
  async function loadCurrentUser() {
    try {
      const res = await fetch('/api/users/me', { headers:{ 'Authorization':'Bearer '+token }});
      if(!res.ok) throw new Error('Session expirÃ©e');
      currentUser = await res.json();
      document.getElementById('userInfo').textContent = `ConnectÃ© en tant que ${currentUser.username}`;
    } catch(err){
      alert('Erreur de connexion : '+err.message);
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      window.location.href = '/connection/connection.html';
    }
  }

  // ========================
  // Compteur de caractÃ¨res
  // ========================
  const textarea = document.getElementById('messageText');
  const charCount = document.getElementById('charCount');
  textarea.addEventListener('input', ()=>{ charCount.textContent = textarea.value.length; });

  // ========================
  // Envoyer le message
  // ========================
  const form = document.getElementById('messageForm');
  const errorMsg = document.getElementById('errorMsg');
  const successMsg = document.getElementById('successMsg');
  const submitBtn = document.getElementById('submitBtn');

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const messageText = textarea.value.trim();
    if(!messageText){ showError('Le message ne peut pas Ãªtre vide'); return; }
    if(!currentUser){ showError('Utilisateur non identifiÃ©'); return; }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Envoi en cours...';

    try{
      const res = await fetch(`/api/messages/user/${currentUser.id}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
        body: JSON.stringify(messageText)
      });
      if(!res.ok) throw new Error('Erreur lors de l\'envoi du message');
      showSuccess('Message publiÃ© avec succÃ¨s !');
      textarea.value = '';
      charCount.textContent = '0';
      setTimeout(()=>{ window.location.href='/menu/affichermessages.html'; }, 2000);
    }catch(err){ showError(err.message); }
    finally{
      submitBtn.disabled=false;
      submitBtn.textContent='Publier le message';
    }
  });

  function showError(msg){ errorMsg.textContent=msg; errorMsg.style.display='block'; successMsg.style.display='none'; }
  function showSuccess(msg){ successMsg.textContent=msg; successMsg.style.display='block'; errorMsg.style.display='none'; }

  loadCurrentUser();
</script>

</body>
</html>
