<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Principal</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
           min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; position:relative;}
    .menu-container { background:white; border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,0.3);
                     overflow:hidden; width:100%; max-width:500px; position:relative; z-index:1;}
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding:50px 30px; text-align:center; color:white;}
    h1 { font-size:2.5rem; font-weight:700; margin-bottom:8px; letter-spacing:-0.5px;}
    .subtitle { font-size:1rem; opacity:0.9; font-weight:400;}
    .menu-content { padding:30px; }
    .menu { display:flex; flex-direction:column; gap:14px; margin-bottom:25px;}
    .menu button { padding:16px 20px; border:none; border-radius:14px; font-size:1.1rem; font-weight:600;
                   cursor:pointer; transition: all 0.3s; font-family:inherit; text-align:left; display:flex; align-items:center; gap:12px;
                   position:relative;}
    .menu button::before { content:attr(data-icon); font-size:1.3rem; }
    .menu button:not(:disabled) { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; box-shadow:0 4px 12px rgba(102,126,234,0.3);}
    .menu button:not(:disabled):hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(102,126,234,0.4);}
    .menu button:not(:disabled):active { transform:translateY(0);}
    .divider { height:1px; background: linear-gradient(to right, transparent, #e5e7eb, transparent); margin:25px 0;}
    .output { background:#f8f9ff; border:2px solid #e5e7eb; border-radius:12px; padding:16px; text-align:center;
              color:#374151; font-size:0.95rem; font-weight:500; }

    /* Styles pour le bouton des pr√©f√©rences musicales */
    .music-preferences-btn { position:relative; }

    .preferences-tooltip {
      position: absolute;
      left: 50%;
      top: -10px;
      transform: translateX(-50%) translateY(-100%);
      background: white;
      border: 2px solid #667eea;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      min-width: 280px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .music-preferences-btn:hover .preferences-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-110%);
    }

    .preferences-tooltip::before {
      content: '';
      position: absolute;
      left: 50%;
      bottom: -8px;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: #667eea;
    }

    .preference-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
    }

    .preference-item:last-child {
      border-bottom: none;
    }

    .preference-genre {
      font-weight: 600;
      color: #374151;
    }

    .preference-level {
      font-size: 0.85rem;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
    }

    .level-3 { background: #dbeafe; color: #2563eb; } /* Adore */
    .level-2 { background: #d1fae5; color: #059669; } /* Appr√©cie */
    .level-1 { background: #fef3c7; color: #d97706; } /* Neutre */
    .level-0 { background: #fee2e2; color: #dc2626; } /* D√©teste */

    .no-preferences {
      color: #6b7280;
      font-style: italic;
      text-align: center;
      padding: 10px 0;
    }

    .preferences-title {
      font-weight: 700;
      color: #667eea;
      margin-bottom: 10px;
      text-align: center;
      font-size: 1rem;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
    }
  </style>
</head>
<body>

<div class="menu-container">
  <div class="header">
    <h1>Menu Principal</h1>
    <p class="subtitle">G√©rez votre espace</p>
  </div>

  <div class="menu-content">
    <div class="menu">
      <button id="btnProfil" data-icon="üë§">Mon Profil</button>
      <button id="btnListeProfils" data-icon="üë•">Liste des membres</button>

      <!-- NOUVEAU BOUTON : Parler avec ma team -->
      <button id="btnTeam" data-icon="üí¨">Parler avec ma team</button>

      <button id="btnPlaylists" data-icon="üéµ">Playlists musicales</button>

      <!-- BOUTON EXISTANT : Voir les pr√©f√©rences musicales -->
      <button id="btnPreferencesMusicales" class="music-preferences-btn" data-icon="üé∂">
        Voir les pr√©f√©rences musicales
        <div class="preferences-tooltip" id="preferencesTooltip">
          <div class="preferences-title">üéµ Mes Pr√©f√©rences Musicales</div>
          <div id="preferencesList">
            <!-- Les pr√©f√©rences seront charg√©es dynamiquement ici -->
          </div>
        </div>
      </button>

      <!-- NOUVEAU BOUTON : Remplissez vos go√ªts musicaux -->
      <button id="btnGoutsMusicaux" data-icon="‚ú®">Remplissez vos go√ªts musicaux</button>

      <!-- NOUVEAU BOUTON : Point commun (ou pas ...) avec les autres -->
      <button id="btnPointCommun" data-icon="üîç">Point commun (ou pas ...) avec les autres</button>

      <!-- NOUVEAU BOUTON : Encode ton son de bienvenue -->
      <button id="btnSonBienvenue" data-icon="üéµ">Encode ton son de bienvenue</button>
    </div>

    <div class="divider"></div>

    <div class="menu">
      <button id="btnLogout" data-icon="üö™">D√©connexion</button>
    </div>

    <div class="output" id="output">S√©lectionnez une option ci-dessus</div>
  </div>
</div>

<script>
  const output = document.getElementById("output");
  const preferencesList = document.getElementById("preferencesList");

  // V√©rifier l'authentification
  const token = localStorage.getItem('accessToken');
  if (!token) {
    alert('Vous devez √™tre connect√© pour acc√©der au menu');
    window.location.href = '/connection/connection.html';
  }

  // Variable pour stocker l'ID de l'utilisateur courant
  let currentUserId = null;

  async function checkAuth() {
    try {
      const response = await fetch('/api/users/me', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!response.ok) throw new Error('Token invalide');

      const userData = await response.json();
      currentUserId = userData.id; // Stocker l'ID de l'utilisateur courant

      return userData;
    } catch (err) {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      alert('Session expir√©e');
      window.location.href = '/connection/connection.html';
    }
  }

  // Fonction pour charger les pr√©f√©rences musicales
  async function loadMusicPreferences() {
    try {
      const response = await fetch('/api/users/me/music-preferences', {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      if (response.ok) {
        const preferences = await response.json();
        displayPreferences(preferences);
      } else {
        preferencesList.innerHTML = '<div class="no-preferences">Aucune pr√©f√©rence musicale d√©finie</div>';
      }
    } catch (err) {
      console.error('Erreur chargement pr√©f√©rences:', err);
      preferencesList.innerHTML = '<div class="no-preferences">Erreur de chargement</div>';
    }
  }

  // Fonction pour afficher les pr√©f√©rences dans le tooltip
  function displayPreferences(preferences) {
    if (!preferences || preferences.length === 0) {
      preferencesList.innerHTML = '<div class="no-preferences">Aucune pr√©f√©rence musicale d√©finie</div>';
      return;
    }

    let html = '';
    preferences.forEach(pref => {
      const levelClass = `level-${pref.level}`;
      const levelText = getLevelText(pref.level);

      html += `
        <div class="preference-item">
          <span class="preference-genre">${formatGenreName(pref.musicType)}</span>
          <span class="preference-level ${levelClass}">${levelText}</span>
        </div>
      `;
    });

    preferencesList.innerHTML = html;
  }

  // Fonction pour formater le nom du genre
  function formatGenreName(genre) {
    const genreNames = {
      'KPOP': 'K-Pop',
      'RAP_FRANCAIS': 'Rap Fran√ßais',
      'RAP_AMERICAIN': 'Rap Am√©ricain',
      'LATINO': 'Latino',
      'COMMERCIAL': 'Commercial',
      'ELECTRO': 'Electro'
    };
    return genreNames[genre] || genre;
  }

  // Fonction pour obtenir le texte du niveau
  function getLevelText(level) {
    const levels = {
      3: '‚ù§Ô∏è Adore',
      2: 'üòä Appr√©cie',
      1: 'üòê Neutre',
      0: 'üò† D√©teste'
    };
    return levels[level] || 'Inconnu';
  }

  // MODIFI√â : Bouton Profil - Redirige vers profil.html avec l'ID utilisateur
  document.getElementById("btnProfil").addEventListener("click", async () => {
    output.textContent = "Chargement de votre profil...";

    try {
      // Si on n'a pas encore l'ID, on le r√©cup√®re
      if (!currentUserId) {
        const userData = await checkAuth();
        currentUserId = userData.id;
      }

      if (currentUserId) {
        output.textContent = "Ouverture de votre profil...";
        // Redirection vers la page profil avec l'ID en param√®tre
        setTimeout(() => {
          window.location.href = `/menu/profil.html?userId=${currentUserId}`;
        }, 300);
      } else {
        output.textContent = "Erreur: Impossible de r√©cup√©rer votre ID";
      }
    } catch (err) {
      output.textContent = "Erreur r√©seau lors du chargement du profil";
      console.error('Erreur:', err);
    }
  });

  // Navigation autres boutons
  document.getElementById("btnListeProfils").addEventListener("click", ()=>{
    output.textContent="Ouverture de la liste des profils...";
    setTimeout(()=>{window.location.href="afficherUserList.html";},300);
  });

  // NOUVEAU : Bouton Parler avec ma team
  document.getElementById("btnTeam").addEventListener("click", ()=>{
    output.textContent="Ouverture de votre espace team...";
    setTimeout(()=>{window.location.href="ma_communaute/ma_communaute.html";},300);
  });

  // MODIFI√â : Bouton Playlists musicales - Nouveau chemin
  document.getElementById("btnPlaylists").addEventListener("click", ()=>{
    output.textContent="Ouverture des playlists musicales...";
    setTimeout(()=>{window.location.href="playlist_menu/playlist_menu.html";},300);
  });

  // NOUVEAU : Bouton Remplissez vos go√ªts musicaux
  document.getElementById("btnGoutsMusicaux").addEventListener("click", ()=>{
    output.textContent="Ouverture du formulaire de go√ªts musicaux...";
    setTimeout(()=>{window.location.href="choix_gout_musicaux.html";},300);
  });

  // NOUVEAU BOUTON : Point commun (ou pas ...) avec les autres
  document.getElementById("btnPointCommun").addEventListener("click", ()=>{
    output.textContent="Recherche des points communs musicaux...";
    setTimeout(()=>{window.location.href="style_music_users/style_music_users.html";},300);
  });

  // NOUVEAU BOUTON : Encode ton son de bienvenue
  document.getElementById("btnSonBienvenue").addEventListener("click", ()=>{
    output.textContent="Ouverture de l'encodeur de son...";
    setTimeout(()=>{window.location.href="menu_encodage_son.html";},300);
  });

  // Bouton Pr√©f√©rences Musicales (clic)
  document.getElementById("btnPreferencesMusicales").addEventListener("click", async () => {
    output.textContent = "Chargement des pr√©f√©rences musicales...";

    try {
      const response = await fetch('/api/users/me/music-preferences', {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      if (response.ok) {
        const preferences = await response.json();
        if (preferences.length > 0) {
          let message = "Vos pr√©f√©rences musicales:\n";
          preferences.forEach(pref => {
            const levelText = getLevelText(pref.level);
            message += `‚Ä¢ ${formatGenreName(pref.musicType)}: ${levelText}\n`;
          });
          output.textContent = message;
        } else {
          output.textContent = "Vous n'avez pas encore d√©fini de pr√©f√©rences musicales";
        }
      } else {
        output.textContent = "Erreur lors du chargement des pr√©f√©rences";
      }
    } catch (err) {
      output.textContent = "Erreur r√©seau lors du chargement des pr√©f√©rences";
    }
  });

  // Charger les pr√©f√©rences au survol du bouton
  document.getElementById("btnPreferencesMusicales").addEventListener("mouseenter", () => {
    loadMusicPreferences();
  });

  // üîπ Bouton D√©connexion
  document.getElementById("btnLogout").addEventListener("click", async () => {
    const refreshToken = localStorage.getItem('refreshToken');
    if (!refreshToken) return;

    try {
      const response = await fetch('/api/auth/logout', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ refreshToken })
      });
      if (response.ok) {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('currentUserData');
        alert('D√©connexion r√©ussie');
        window.location.href = '/connection/connection.html';
      } else {
        alert('Erreur lors de la d√©connexion');
      }
    } catch (err) {
      alert('Erreur r√©seau lors de la d√©connexion');
    }
  });

  // Initialisation - R√©cup√©rer l'ID utilisateur au chargement
  checkAuth();
</script>

</body>
</html>